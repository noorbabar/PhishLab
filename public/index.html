<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhishBox Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number { font-size: 2rem; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; margin-top: 0.5rem; }
        .section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .btn:hover { background: #5a6fd8; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .table th, .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .table th { background: #f8f9fa; font-weight: bold; }
        .hidden { display: none; }
        .test-links {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .test-link {
            display: block;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            text-decoration: none;
            color: #333;
            border: 1px solid #ddd;
        }
        .test-link:hover {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🎣 PhishBox Dashboard</h1>
            <p>Phishing Simulation Training Platform</p>
        </div>
    </div>

    <div class="container">
        <!-- Stats Dashboard -->
        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Navigation -->
        <div class="section">
            <button class="btn" onclick="showSection('targets')">Manage Targets</button>
            <button class="btn" onclick="showSection('campaigns')">Campaigns</button>
            <button class="btn" onclick="showSection('results')">Results</button>
        </div>

        <!-- Targets Section -->
        <div id="targets-section" class="section hidden">
            <h2>Target Management</h2>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                <div>
                    <h3>Add New Target</h3>
                    <form id="targetForm">
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="targetEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" id="targetName" required>
                        </div>
                        <div class="form-group">
                            <label>Department:</label>
                            <input type="text" id="targetDepartment">
                        </div>
                        <button type="submit" class="btn">Add Target</button>
                    </form>
                </div>
                <div>
                    <h3>Existing Targets</h3>
                    <div id="targetsList"></div>
                </div>
            </div>
        </div>

        <!-- Campaigns Section -->
        <div id="campaigns-section" class="section hidden">
            <h2>Campaign Management</h2>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                <div>
                    <h3>Create New Campaign</h3>
                    <form id="campaignForm">
                        <div class="form-group">
                            <label>Campaign Name:</label>
                            <input type="text" id="campaignName" required>
                        </div>
                        <div class="form-group">
                            <label>Template:</label>
                            <select id="campaignTemplate" required>
                                <option value="">Select template</option>
                                <option value="invoice">Fake Invoice</option>
                                <option value="login">Security Alert</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Select Targets:</label>
                            <div id="targetCheckboxes"></div>
                        </div>
                        <button type="submit" class="btn">Create Campaign</button>
                    </form>
                </div>
                <div>
                    <h3>Existing Campaigns</h3>
                    <div id="campaignsList"></div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="section hidden">
            <h2>Campaign Results</h2>
            <div id="resultsList"></div>
        </div>
    </div>

    <script>
        // Load dashboard stats
        async function loadStats() {
            try {
                const response = await fetch('/api/dashboard');
                const stats = await response.json();
                
                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalTargets || 0}</div>
                        <div class="stat-label">Total Targets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.activeCampaigns || 0}</div>
                        <div class="stat-label">Active Campaigns</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.clickedLinks || 0}</div>
                        <div class="stat-label">Links Clicked</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.enteredCredentials || 0}</div>
                        <div class="stat-label">Credentials Entered</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Show/hide sections
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => {
                if (s.id.includes('-section')) s.classList.add('hidden');
            });
            document.getElementById(section + '-section').classList.remove('hidden');
            
            if (section === 'targets') loadTargets();
            if (section === 'campaigns') { loadCampaigns(); loadTargetsForCampaign(); }
            if (section === 'results') loadCampaigns();
        }

        // Load targets
        async function loadTargets() {
            try {
                const response = await fetch('/api/targets');
                const targets = await response.json();
                
                document.getElementById('targetsList').innerHTML = `
                    <table class="table">
                        <thead>
                            <tr><th>Name</th><th>Email</th><th>Department</th></tr>
                        </thead>
                        <tbody>
                            ${targets.map(t => `
                                <tr>
                                    <td>${t.name}</td>
                                    <td>${t.email}</td>
                                    <td>${t.department || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading targets:', error);
            }
        }

        // Load targets for campaign creation
        async function loadTargetsForCampaign() {
            try {
                const response = await fetch('/api/targets');
                const targets = await response.json();
                
                document.getElementById('targetCheckboxes').innerHTML = targets.map(t => `
                    <label style="display: block; margin: 0.5rem 0;">
                        <input type="checkbox" value="${t.id}" style="margin-right: 0.5rem;">
                        ${t.name} (${t.email})
                    </label>
                `).join('');
            } catch (error) {
                console.error('Error loading targets:', error);
            }
        }

        // Add target
        document.getElementById('targetForm').onsubmit = async function(e) {
            e.preventDefault();
            
            try {
                const response = await fetch('/api/targets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('targetEmail').value,
                        name: document.getElementById('targetName').value,
                        department: document.getElementById('targetDepartment').value
                    })
                });
                
                if (response.ok) {
                    alert('Target added successfully!');
                    document.getElementById('targetForm').reset();
                    loadTargets();
                    loadStats();
                }
            } catch (error) {
                console.error('Error adding target:', error);
                alert('Error adding target');
            }
        };

        // Load campaigns
        async function loadCampaigns() {
            try {
                const response = await fetch('/api/campaigns');
                const campaigns = await response.json();
                
                const campaignsList = document.getElementById('campaignsList');
                if (campaignsList) {
                    campaignsList.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr><th>Name</th><th>Template</th><th>Created</th><th>Actions</th></tr>
                            </thead>
                            <tbody>
                                ${campaigns.map(c => `
                                    <tr>
                                        <td>${c.name}</td>
                                        <td>${c.template}</td>
                                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                                        <td>
                                            <button class="btn btn-success" onclick="sendEmails(${c.id})">Send Emails</button>
                                            <button class="btn" onclick="showTestMode(${c.id})">Test Mode</button>
                                            <button class="btn" onclick="showResults(${c.id})">View Results</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Error loading campaigns:', error);
            }
        }

        // Create campaign
        document.getElementById('campaignForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const selectedTargets = Array.from(document.querySelectorAll('#targetCheckboxes input:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selectedTargets.length === 0) {
                alert('Please select at least one target');
                return;
            }
            
            try {
                const response = await fetch('/api/campaigns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('campaignName').value,
                        template: document.getElementById('campaignTemplate').value,
                        targetIds: selectedTargets
                    })
                });
                
                if (response.ok) {
                    alert('Campaign created successfully!');
                    document.getElementById('campaignForm').reset();
                    loadCampaigns();
                    loadStats();
                }
            } catch (error) {
                console.error('Error creating campaign:', error);
                alert('Error creating campaign');
            }
        };

        // Send emails
        async function sendEmails(campaignId) {
            if (!confirm('Are you sure you want to send phishing emails?')) return;
            
            try {
                const response = await fetch(`/api/campaigns/${campaignId}/send`, {
                    method: 'POST'
                });
                const result = await response.json();
                alert(result.message);
                loadStats();
            } catch (error) {
                console.error('Error sending emails:', error);
                alert('Error sending emails');
            }
        }

        // Show test mode
        async function showTestMode(campaignId) {
            try {
                // First activate test mode
                const testResponse = await fetch(`/api/campaigns/${campaignId}/test-mode`, {
                    method: 'POST'
                });
                const testResult = await testResponse.json();
                
                // Then get test links
                const linksResponse = await fetch(`/api/campaigns/${campaignId}/test-links`);
                const links = await linksResponse.json();
                
                const testLinksHtml = `
                    <div class="test-links">
                        <h3>🧪 Test Mode Activated</h3>
                        <p>Click these links to simulate the phishing experience for each target:</p>
                        ${links.map(link => `
                            <a href="${link.testUrl}" target="_blank" class="test-link">
                                <strong>${link.name}</strong> (${link.email})
                                <br><small>${link.testUrl}</small>
                            </a>
                        `).join('')}
                        <p><small>💡 Tip: Open links in new tabs to test the full phishing simulation</small></p>
                    </div>
                `;
                
                // Show in campaigns section
                const existingTestLinks = document.querySelector('.test-links');
                if (existingTestLinks) existingTestLinks.remove();
                
                document.getElementById('campaignsList').insertAdjacentHTML('afterend', testLinksHtml);
                loadStats();
                
            } catch (error) {
                console.error('Error activating test mode:', error);
                alert('Error activating test mode');
            }
        }

        // Show results
        async function showResults(campaignId) {
            try {
                const response = await fetch(`/api/campaigns/${campaignId}/results`);
                const results = await response.json();
                
                showSection('results');
                document.getElementById('resultsList').innerHTML = `
                    <h3>Campaign Results</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Department</th>
                                <th>Email Sent</th>
                                <th>Link Clicked</th>
                                <th>Credentials Entered</th>
                                <th>Click Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(r => `
                                <tr>
                                    <td>${r.name}</td>
                                    <td>${r.email}</td>
                                    <td>${r.department || 'N/A'}</td>
                                    <td>${r.email_sent ? '✅' : '❌'}</td>
                                    <td>${r.link_clicked ? '⚠️' : '✅'}</td>
                                    <td>${r.credentials_entered ? '❌' : '✅'}</td>
                                    <td>${r.clicked_at ? new Date(r.clicked_at).toLocaleString() : 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        // Initialize dashboard
        loadStats();
    </script>
</body>
</html>